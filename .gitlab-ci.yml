# Spécifier l'image de base pour les jobs
image: docker:latest

# Définition des variables d'environnement
variables:
  SSH_USER: "$SSH_USER"
  SSH_PASSWORD: "$SSH_PASSWORD"
  SSH_HOST: "$SSH_HOST"
  SSH_PORT: "$SSH_PORT"
  PROJECT_PATH: "$PROJECT_PATH"

# Jobs de la pipeline
stages:
  - deploy

deploy:
  stage: deploy
  script:
    - yum install -y epel-release && yum install -y sshpass # installer sshpass si nécessaire
  
    # Connexion au serveur distant via SSH avec authentification par mot de passe
    - sshpass -p "$SSH_PASSWORD" ssh -p "$SSH_PORT" "$SSH_USER"@"$SSH_HOST" "echo Connected"

    # Cloner le dépôt Git ou récupérer les dernières modifications
    - sshpass -p "$SSH_PASSWORD" ssh -p "$SSH_PORT" "$SSH_USER"@"$SSH_HOST" "( cd ~/Cube-3-back && git pull --rebase ) || git clone $PROJECT_PATH"

    # Lancement de la composition Docker
    - sshpass -p "$SSH_PASSWORD" ssh -p "$SSH_PORT" "$SSH_USER"@"$SSH_HOST" "cd ~/Cube-3-back && docker compose down && docker compose down"
    
  when: manual